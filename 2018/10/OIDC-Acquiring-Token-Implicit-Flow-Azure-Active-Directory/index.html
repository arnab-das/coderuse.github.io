<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@coderuse"><meta name="twitter:title" content="OIDC - Acquiring Access Token By Implicit Flow From Azure Active Directory"><meta name="twitter:description" content="&lt;p&gt;&lt;a href=&quot;https://openid.net/connect/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OpenID Connect&lt;/a&gt;, outlined by &lt;a href=&quot;https://tools.ietf.org/html/rfc6749&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;RFC-6749&lt;/a&gt;, allows web based clients to authenticate end users with identity providers and acquire access-token to be used to access web resources, API’s, protected by &lt;a href=&quot;https://en.wikipedia.org/wiki/OAuth#OAuth_2.0&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;OAuth 2.0&lt;/a&gt; compatible frameworks.&lt;/p&gt;"><meta name="twitter:image" content="http://i.imgur.com/9RX3TO3.png"><title>OIDC - Acquiring Access Token By Implicit Flow From Azure Active Directory | CodeRuse</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300|Roboto:300|Inconsolata"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="amphtml" href="./amp/index.html"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">CodeRuse</a><!--span.subtitle= config.subtitle--><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><div id="top-nav" class="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" target="_blank" class="sidebar-nav-item">Archives</a><a href="http://galleries.coderuse.com" target="_blank" class="sidebar-nav-item">Galleries</a><a href="/about" target="_blank" class="sidebar-nav-item">About</a></div></div><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>OIDC - Acquiring Access Token By Implicit Flow From Azure Active Directory</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">Oct 11, 2018</div><div class="post-categories"><a class="post-category-link" href="/categories/PAAS/">PAAS</a>><a class="post-category-link" href="/categories/PAAS/IDAS/">IDAS</a>><a class="post-category-link" href="/categories/PAAS/IDAS/Technical/">Technical</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/active-active-directory/">active-active-directory</a>/<a class="post-tag-link" href="/tags/oidc/">oidc</a>/<a class="post-tag-link" href="/tags/openid-connect/">openid-connect</a></div></div></div><article><div class="container post"><p><a href="https://openid.net/connect/" target="_blank" rel="external">OpenID Connect</a>, outlined by <a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="external">RFC-6749</a>, allows web based clients to authenticate end users with identity providers and acquire access-token to be used to access web resources, API’s, protected by <a href="https://en.wikipedia.org/wiki/OAuth#OAuth_2.0" target="_blank" rel="external">OAuth 2.0</a> compatible frameworks.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis" target="_blank" rel="external">Azure Active Directory</a> is a identity management service offered by Microsoft hosted on <a href="https://azure.microsoft.com/en-us/services/active-directory/" target="_blank" rel="external">Azure</a> cloud platform. It offers management of user, group and roles within cloud instance of Active Directory. AAD supports all the handshakes outlined by RFC-6749. With a <a href="https://docs.microsoft.com/en-us/azure/active-directory/" target="_blank" rel="external">vast library of documents</a> from Microsoft, it’s easy to go through the how-tos and quickly spin up a web app authenticating with AAD. But within the tutorials they mostly use complex libraries like <a href="https://github.com/AzureAD/azure-activedirectory-library-for-js" target="_blank" rel="external">ADAL.Js</a> or <a href="https://github.com/AzureAD/microsoft-authentication-library-for-js" target="_blank" rel="external">MSAL.Js</a> for client side authentication with AAD. The libraries are no-doubt very convenient to use and have lot of features. But libraries hides the inner management of urls and the parameters are requested with.</p>
<p>In this post we are going to examine the <a href="https://tools.ietf.org/html/rfc6749#section-4.2" target="_blank" rel="external">implicit grant</a> of OIDC with <a href="https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-implicit-grant-flow" target="_blank" rel="external">AAD</a> by creating a very simple web app. The source of the web app is available on <a href="https://github.com/coderuse/aad-implicit-flow" target="_blank" rel="external">GitHub</a> and hosted at <a href="https://coderuse.github.io/aad-implicit-flow/" target="_blank" rel="external">coderuse.github.io/aad-implicit-flow</a>. Here we are not exploring the implicit flow in whole, rather trying to understand the redirections happens during the auhtentication. I would recommend to go through the links provided here for the starter for a better understanding.</p>
<p>When we are working with browser for OAuth-2.0 authentication, it needs to be understood that urls that are being redirected to and from are very important. All the parameters are needed to be passed via urls and the responses are also needed to be parsed from urls. For this we need some <a href="https://github.com/coderuse/aad-implicit-flow/blob/master/app.js#L4-L29" target="_blank" rel="external">utility methods</a> to parse urls for response. These methods are taken from ADAL.</p>
<p>The process starts with checking whether the access token is present in the url or not. For that we are using the following method.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isSignInProgress</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> hash = <span class="built_in">window</span>.location.hash;</span><br><span class="line">    <span class="keyword">if</span> (hash) &#123;</span><br><span class="line">        hash = getHash(hash);</span><br><span class="line">        <span class="keyword">var</span> parameters = deserialize(hash);</span><br><span class="line">        <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">            <span class="keyword">if</span> (parameters.hasOwnProperty(<span class="string">'error_description'</span>)) &#123;</span><br><span class="line">                <span class="keyword">var</span> errorDescription = parameters[<span class="string">'error_description'</span>];</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    error: &#123;</span><br><span class="line">                        description: errorDescription</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (parameters.hasOwnProperty(<span class="string">'access_token'</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> parameters[<span class="string">'access_token'</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We invoke the above method from a time elapsed method by <code>setTimeout</code> like the following.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> intrvl = setInterval(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> accessToken = isSignInProgress();</span><br><span class="line">    <span class="keyword">if</span> (accessToken) &#123;</span><br><span class="line">        clearInterval(intrvl);</span><br><span class="line">        <span class="keyword">if</span> (accessToken.error) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(accessToken.error.description);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'id-access-token'</span>).value = accessToken;</span><br><span class="line">            <span class="built_in">console</span>.log(accessToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else &#123; redirect to the provider to acquire token</span></span><br><span class="line">        <span class="comment">// loginRedirect(tenant, clientId, scope);</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">&#125;, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p>Need for this timeout is to prevent auto-redirection. To take the input from user, the need to auto redirect the login page to authentication provider does not arise here. But in actual application, the required information are already present. So, no need to wait for login initiation by user, like we are doing in the demo app. Typically the page should be redirected from the else block of the above method.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loginRedirect</span>(<span class="params">tenant, clientId, scope</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> loginUri = <span class="string">'https://login.microsoftonline.com/'</span> + tenant + <span class="string">'/oauth2/v2.0/authorize?'</span>;</span><br><span class="line">    <span class="keyword">var</span> params = [];</span><br><span class="line">    params.push(<span class="string">'client_id='</span> + clientId);</span><br><span class="line">    params.push(<span class="string">'response_type=id_token token'</span>);</span><br><span class="line">    params.push(<span class="string">'redirect_uri=https://coderuse.github.io/aad-implicit-flow/'</span>);</span><br><span class="line">    params.push(<span class="string">'scope=openid '</span> + scope);</span><br><span class="line">    params.push(<span class="string">'response_mode=fragment'</span>);</span><br><span class="line">    params.push(<span class="string">'state=12345'</span>);</span><br><span class="line">    params.push(<span class="string">'nonce=678910'</span>);</span><br><span class="line">    loginUri += <span class="built_in">decodeURIComponent</span>(params.join(<span class="string">'&amp;'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.location.replace(loginUri);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here we are using <code>id_token token</code> to get the access token in a single redirection. The recommended way of doing this is to first acquire the <code>id_token</code> and then acquire the <code>access_token</code> silently(without any further user inputs) via an iframe. But in reality, the second part, creating iframe and all does not work due to the restrictions posed by the modern browsers. And iframes should be discarded by all means in production deployments. And it’s really difficult to work with iframes on <a href="https://cordova.apache.org/" target="_blank" rel="external">Cordova</a>. So, a second redirection or creating a popup window with proper url containing the <code>id_token</code> is required to be invoked to get the access token.</p>
<p>Though <code>implicit flow</code> is recommended for browser app. In my opinion <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank" rel="external">auth code flow</a> is more appropriate than the prior one. We will have one more post with <code>auth code flow</code>.</p>
</div><!-- comment system--><div class="container"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'coderuse';
var disqus_identifier = '2018/10/OIDC-Acquiring-Token-Implicit-Flow-Azure-Active-Directory/';
var disqus_title = "OIDC - Acquiring Access Token By Implicit Flow From Azure Active Directory";
var disqus_url = 'http://coderuse.com/2018/10/OIDC-Acquiring-Token-Implicit-Flow-Azure-Active-Directory/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><div id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/coderuse" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/coderuse" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+ArnabDasUIDeveloper" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© <a href="/" rel="nofollow">CodeRuse</a> | <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0</a></div></div></div></div><script>var trackID = 'UA-70816071-1', domainID = 'coderuse.com';(function (i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){(i[r].q=i[r].q || []).push(arguments);},i[r].l = 1 * new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)})(window, document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', trackID, domainID);ga('send', 'pageview');</script></body></html>