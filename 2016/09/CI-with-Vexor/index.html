<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CI with Vexor | CodeRuse</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300|Roboto:300|Inconsolata"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">CodeRuse</a><!--span.subtitle= config.subtitle--><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><div id="top-nav" class="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" target="_blank" class="sidebar-nav-item">Archives</a><a href="http://galleries.coderuse.com" target="_blank" class="sidebar-nav-item">Galleries</a><a href="/about" target="_blank" class="sidebar-nav-item">About</a></div></div><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>CI with Vexor</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">Sep 10, 2016</div><div class="post-categories"><a class="post-category-link" href="/categories/CI/">CI</a>><a class="post-category-link" href="/categories/CI/Cookbook/">Cookbook</a>><a class="post-category-link" href="/categories/CI/Cookbook/System/">System</a>><a class="post-category-link" href="/categories/CI/Cookbook/System/Technical/">Technical</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ci/">ci</a>/<a class="post-tag-link" href="/tags/nodejs/">nodejs</a>/<a class="post-tag-link" href="/tags/vexor/">vexor</a></div></div></div><article><div class="container post"><p>Today I’ve configured CI with <a href="https://vexor.io/" target="_blank" rel="external">Vexor</a> for this blog. Actually I use <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a> to generate a static site and then upload the generated static content to the remote machine, hosting the blog. Quite simple.</p>
<p>Generating the static pages and then upload them to the remote machine takes a lot of effort beside writing a post. And the job is so repetitive. So, CI is a very good use case for this. But, as I use private repo for this, most of the prominent CI hosts charge a lot to build for private repos. After searching a little bit, got the name of <a href="https://vexor.io/" target="_blank" rel="external">Vexor</a>. The best thing is that, they are not limiting you, 1 build unit, 2 build units, private repo etc. You start with free 100 build minutes, then $0.015/min. Quite cheap. And no prior commitment with huge monthly subscriptions (Others are really pricey. I don’t understand, why do they charge over $30/month for a single unit, while builds for most of the normal projects does not go over 1hr. And how many builds per day a project can see. I don’t know.) So, I pleased with the pricing matrix of <a href="https://vexor.io/" target="_blank" rel="external">Vexor</a>.</p>
<p>One problem with them is they have not yet completed their documentation fully. And their whole doc is full of examples of building Ruby applications. Probably they are fond of Ruby. I’ve no complains. But they should include at-least some full examples for NodeJS. Then I came across one of the features in their build system. You can log into the build container for 30 mins (if you enable ssh) to debug. So, nice feature. Probably use only once for one project but that’s big.</p>
<p>So, I started to configure. First steps are quite straight-forward. Go to <a href="https://vexor.io/" target="_blank" rel="external">Vexor</a>. Sign up with Github or GitLab or Bitbucket account. Enable your repo. You should be able to see the repo in your <a href="https://ci.vexor.io/ui/" target="_blank" rel="external">Dashboard</a>. As soon as the repo is connected, it will try to start the build. But, my repo was not configured. Naturally, first build failed. Then I started to configure.</p>
<p>First, added one file to the root of the repo by the name <code>.vexor.yml</code> (<code>vexor.yml</code>, without the leading dot is also permissible).</p>
<p>As I want to build for NodeJS. I added <code>language: node_js</code>. They have support for several versions of Node. I added for <code>6.1.0</code>.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">language: node_js&#10;node_js:&#10;- &#34;6.1.0&#34;</span><br></pre></td></tr></table></figure>
<p>I use <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a> to generate the site. And this needs <code>hexo-cli</code> to be installed globally. So, I added <code>npm install -g hexo-cli</code> and of-course <code>npm install</code> to the <code>install</code> section.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">install:&#10;- npm install -g hexo-cli&#10;- npm install</span><br></pre></td></tr></table></figure>
<p>As I’ve included one post-install hook to the <code>package.json</code> with the command <code>hexo generate</code>, practically I’ve nothing to do for generation of static content in the <code>script</code> section.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">  ,</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "postinstall": "hexo generate"</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, I need to upload the generated content to the remote site. So, added some lines (with the help of <a href="https://gist.github.com/domenic/ec8b0fc8ab45f39403dd" target="_blank" rel="external">Domenic</a>) to the <code>before_script</code> section to add the <code>ssh-key</code> to <code>ssh agent</code>.</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">before_script:&#10;- chmod 600 /home/vexor/.ssh/id_rsa&#10;- eval `ssh-agent -s`&#10;- ssh-add /home/vexor/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<p>The available key in the <code>.ssh</code> is the private key you have to add in the settings of the project. You can generate one key pair by <code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</code>. <a href="https://help.github.com/articles/generating-an-ssh-key/" target="_blank" rel="external">More detail</a>. And add the content of the public key of the pair to a file named <code>authorized_keys</code> in the <code>.ssh</code> directory of <code>home</code> of the user, you want to deploy with, to the remote machine.</p>
<p>To deploy I’ve added one shell script file, named <code>deploy</code> in my repo. (taken from <a href="https://coderwall.com/p/moabdw/using-rsync-to-deploy-a-website-easy-one-liner-command" target="_blank" rel="external">here</a>). Only I modified the <code>userid</code>, <code>server address</code>, added <code>cd public</code> (from where we need to upload), the remote directory path and removed the <code>exclude-from</code> flag.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="shebang">#!/bin/bash</span><br><span class="line"></span></span><br><span class="line"><span class="built_in">cd</span> public</span><br><span class="line"><span class="variable">$ERRORSTRING</span>=<span class="string">"Error. Please make sure you've indicated correct parameters"</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-eq</span> <span class="number">0</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$ERRORSTRING</span>;</span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$1</span> == <span class="string">"live"</span> ]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [[ -z <span class="variable">$2</span> ]]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Running dry-run"</span></span><br><span class="line">                rsync --dry-run -az --force --delete --progress <span class="operator">-e</span> <span class="string">"ssh -p22"</span> ./ build@xx.xx.xx.xx:/usr/share/nginx/html</span><br><span class="line">        <span class="keyword">elif</span> [ <span class="variable">$2</span> == <span class="string">"go"</span> ]</span><br><span class="line">            <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"Running actual deploy"</span></span><br><span class="line">                rsync -az --force --delete --progress <span class="operator">-e</span> <span class="string">"ssh -p22"</span> ./ build@xx.xx.xx.xx:/usr/share/nginx/html</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="variable">$ERRORSTRING</span>;</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>This file <code>deploy</code> need to executable. So, added <code>chmod +x ./deploy</code> to the <code>before_script</code> section.</p>
<p>And finally in the <code>script</code> section added <code>./deploy live go</code>, which will deploy the generated content to the remote directory, if all things go successfully.</p>
<p>If anyone needs the full glimpse of <code>.vexor.yml</code>, here it is,</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">language: node_js&#10;node_js:&#10;- &#34;6.1.0&#34;&#10;install:&#10;- npm install -g hexo-cli&#10;- npm install&#10;before_script:&#10;- chmod 600 /home/vexor/.ssh/id_rsa&#10;- eval `ssh-agent -s`&#10;- ssh-add /home/vexor/.ssh/id_rsa&#10;- chmod +x ./deploy&#10;script: ./deploy live go</span><br></pre></td></tr></table></figure></div><!-- comment system--><div class="container"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'coderuse';
var disqus_identifier = '2016/09/CI-with-Vexor/';
var disqus_title = "CI with Vexor";
var disqus_url = 'http://coderuse.com/2016/09/CI-with-Vexor/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><div id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/coderuse" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/coderuse" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+ArnabDasUIDeveloper" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© <a href="/" rel="nofollow">CodeRuse</a> | <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0</a></div></div></div></div><script>var trackID = 'UA-70816071-1', domainID = 'coderuse.com';(function (i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){(i[r].q=i[r].q || []).push(arguments);},i[r].l = 1 * new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)})(window, document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', trackID, domainID);ga('send', 'pageview');</script></body></html>